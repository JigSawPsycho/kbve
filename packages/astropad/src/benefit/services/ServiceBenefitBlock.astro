---
import { getCollection } from 'astro:content';
import { z } from 'zod';

interface Props {
  collectionID: string;
  collectionTag: string;
  featured?: boolean;
}

const statSchema = z.object({
  title: z.string(),
  data: z.string(),
  html: z.string().optional(),
});

const { collectionID, collectionTag, featured = true } = Astro.props;

const servicesCollection = await getCollection(collectionID);

const servicesEntries = servicesCollection.filter(
  (entry: { data: { tags: string | string[] } }) =>
    Array.isArray(entry.data.tags) &&
    entry.data.tags.includes(collectionTag) &&
    (featured ? entry.data.tags.includes('featured') : true)
);

const filteredItems = servicesEntries.map(
  (entry: {
    slug: any;
    data: {
      [x: string]: any;
      unsplash: any;
      title: any;
      description: any;
      tags: any;
      img: any;
      lottie: any;
      stats: any;
    };
  }) => ({
    id: entry.slug,
    unsplash: entry.data.unsplash,
    name: entry.data.title,
    description: entry.data.description,
    tags: entry.data.tags,
    img: entry.data.img,
    lottie: entry.data.lottie,
    stats: entry.data['stats']
      ? entry.data['stats'].map((stat: any) => statSchema.parse(stat))
      : [],
  })
);

const hasItems = filteredItems.length > 0;
const displayItems = hasItems
  ? filteredItems.map(
      (item: {
        id?: string;
        name?: string;
        slug?: string;
        description?: string;
        unsplash?: string;
        img?: string;
        lottie?: string;
        stats?: { title: string; data: string; html?: string }[];
      }) => ({
        id: item.id || item.slug || 'missing-id',
        name: item.name || item.slug || 'Missing id, name, or slug',
        description: item.description || 'No description available',
        unsplash: item.unsplash || '',
        lottie:
          item.lottie ||
          `
        <dotlottie-player
				autoplay
				loop
				class="w-24 md:w-48 lg:w-96 aspect-video"
				mode="normal"
				src="https://kbve.com/assets/lottie/beer.lottie">
			</dotlottie-player>`,
        img: item.img || '',
        stats: item.stats || [],
      })
    )
  : [];
---

<section class="m-4 p-4 lg:p-8 text-gray-100">
  <div class="container mx-auto space-y-12">
    {
      hasItems ? (
        displayItems.map(
          (
            item: {
              id: string | null | undefined;
              name: string;
              description: string;
              unsplash: string;
              img: string;
              lottie: string;
              stats: { title: string; data: string; html?: string }[];
            },
            index: number
          ) => (
            <div
              class={`flex flex-col overflow-hidden rounded-md shadow-sm lg:${index % 2 === 0 ? 'flex-row' : 'flex-row'} bg-cover max-h-[500px]`}
              style={`background-image: url(https://images.unsplash.com/photo-${item.unsplash}?fit=crop&w=1400&h=500&q=75)`}
              id={item.id}>
              <div class={`flex flex-col justify-center flex-1 p-6`}>
                <div class="bg-cyan-400/20 p-4 inline-block">
                  <h3 class="text-3xl font-bold">{item.name}</h3>
                </div>
                <div class="bg-cyan-400/10 p-4 inline-block">
                  <p class="my-6 dark:text-gray-200">{item.description}</p>
                </div>
                <div class="bg-cyan-400/10 p-4 inline-block space-y-2">
                  {item.stats.length > 0 && (
                    <div>
                      <ul class="list-disc list-inside">
                        {item.stats.slice(1).map((stat, i) => (
                          <div class="flex items-center space-x-2">
                            <div class="text-xl font-semibold">
                              Title: {stat.title}
                            </div>
                            <div class="text-gray-200">Data: {stat.data}</div>
                            {stat.html && <Fragment set:html={stat.html} />}
                          </div>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>

                <button type="button" class="self-start">
                  Action
                </button>
              </div>

              <div class="object-scale-down shrink">
                <Fragment set:html={item.lottie} />
              </div>
            </div>
          )
        )
      ) : (
        <div>No items found with the tag "{collectionTag}"</div>
      )
    }
  </div>
</section>
